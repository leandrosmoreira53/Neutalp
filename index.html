<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta Neutral Vault - Testnet Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
            text-transform: uppercase;
        }

        .info-value {
            color: #333;
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 5px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            grid-column: 1 / -1;
        }

        .btn-primary:hover {
            background: #5568d3;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        .status {
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .badge.connected {
            background: #48bb78;
        }

        .badge.disconnected {
            background: #f56565;
        }

        .copy-btn {
            padding: 5px 10px;
            font-size: 0.85em;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .copy-btn:hover {
            background: #5568d3;
        }

        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .step-indicator {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }

        .step {
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            color: #999;
            border: 2px solid #e0e0e0;
        }

        .step.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .step.completed {
            background: #48bb78;
            color: white;
            border-color: #48bb78;
        }

        .fee-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .fee-item {
            background: #f0f4ff;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .fee-label {
            font-size: 0.85em;
            color: #666;
        }

        .fee-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }

            .step-indicator {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>âš¡ Delta Neutral Vault</h1>
            <p class="subtitle">Testnet Interface - Arbitrum Sepolia</p>
        </header>

        <div class="step-indicator">
            <div class="step active" id="step1">1. Connect</div>
            <div class="step" id="step2">2. Deposit</div>
            <div class="step" id="step3">3. Range</div>
            <div class="step" id="step4">4. Rebalance</div>
            <div class="step" id="step5">5. Withdraw</div>
        </div>

        <div class="main-grid">
            <!-- WALLET SECTION -->
            <div class="card">
                <h2>ðŸ’¼ Wallet</h2>
                
                <div class="input-group">
                    <label for="walletAddress">Your Address</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="walletAddress" placeholder="0x..." readonly>
                        <button class="copy-btn" onclick="copyToClipboard('walletAddress')">Copy</button>
                    </div>
                </div>

                <div class="info-box">
                    <div class="info-label">Connection Status</div>
                    <div style="margin-top: 10px;">
                        <button class="btn-primary" id="connectBtn" onclick="connectWallet()">
                            Connect MetaMask
                        </button>
                        <div class="badge disconnected" id="statusBadge">Disconnected</div>
                    </div>
                </div>

                <div class="info-box" id="balanceBox" style="display: none;">
                    <div class="info-label">USDC Sepolia Balance</div>
                    <div class="info-value" id="usdcBalance">0.00</div>
                </div>

                <div class="info-box" id="sharesBox" style="display: none;">
                    <div class="info-label">Your Shares (dnvUSDC)</div>
                    <div class="info-value" id="shareBalance">0.00</div>
                </div>

                <div class="info-box" id="shareValueBox" style="display: none;">
                    <div class="info-label">Share Value (USDC)</div>
                    <div class="info-value" id="shareValue">0.00</div>
                </div>
            </div>

            <!-- VAULT INFO SECTION -->
            <div class="card">
                <h2>ðŸ“Š Vault Status</h2>

                <div class="info-box">
                    <div class="info-label">Vault Address</div>
                    <div class="info-value" style="font-size: 0.95em;">0x6cf579...</div>
                    <button class="copy-btn" onclick="copyToClipboard('vaultAddr')">Copy</button>
                    <input type="hidden" id="vaultAddr" value="0x6cf5791356EEf878536Ee006f18410861D93198D">
                </div>

                <div class="info-box" id="totalAssetsBox" style="display: none;">
                    <div class="info-label">Total Assets (USDC)</div>
                    <div class="info-value" id="totalAssets">0.00</div>
                </div>

                <div class="info-box" id="totalSupplyBox" style="display: none;">
                    <div class="info-label">Total Supply (shares)</div>
                    <div class="info-value" id="totalSupply">0.00</div>
                </div>

                <div class="fee-info">
                    <div class="fee-item">
                        <div class="fee-label">Performance Fee</div>
                        <div class="fee-value">5%</div>
                    </div>
                    <div class="fee-item">
                        <div class="fee-label">Management Fee</div>
                        <div class="fee-value">2%</div>
                    </div>
                    <div class="fee-item">
                        <div class="fee-label">Swap Fee</div>
                        <div class="fee-value">0.3%</div>
                    </div>
                    <div class="fee-item">
                        <div class="fee-label">Keeper Fee</div>
                        <div class="fee-value">0.1%</div>
                    </div>
                </div>
            </div>

            <!-- DEPOSIT SECTION -->
            <div class="card">
                <h2>ðŸ’° Deposit</h2>

                <div class="input-group">
                    <label for="depositAmount">Amount (USDC)</label>
                    <input type="number" id="depositAmount" placeholder="10" min="0" step="0.1">
                    <small style="color: #999; margin-top: 5px;">Recomendado: 10 USDC para teste</small>
                </div>

                <div class="input-group">
                    <label for="depositReceiver">Receiver Address</label>
                    <input type="text" id="depositReceiver" placeholder="0x...">
                </div>

                <button class="btn-primary" onclick="deposit()">
                    <span id="depositText">Deposit USDC</span>
                    <span class="loader" id="depositLoader"></span>
                </button>

                <div class="status" id="depositStatus" style="display: none;"></div>
            </div>

            <!-- RANGE SECTION -->
            <div class="card">
                <h2>ðŸ“ˆ Set Range</h2>
                <p>Configure the price range for WBTC/USDC position</p>

                <div class="two-col">
                    <div class="input-group">
                        <label for="priceLower">Price Lower (USDC/WBTC)</label>
                        <input type="number" id="priceLower" placeholder="93000" value="93000">
                    </div>
                    <div class="input-group">
                        <label for="priceUpper">Price Upper (USDC/WBTC)</label>
                        <input type="number" id="priceUpper" placeholder="100000" value="100000">
                    </div>
                </div>

                <button class="btn-primary" onclick="convertPricesToTicks()" style="margin: 10px 0;">
                    Convert to Ticks
                </button>

                <div style="margin: 15px 0; padding: 15px; background: #f0f0f0; border-radius: 8px;">
                    <p style="margin: 0; font-size: 12px; color: #666; margin-bottom: 10px;">Calculated Ticks:</p>
                    <div class="two-col">
                        <div>
                            <small style="color: #666;">Tick Lower</small>
                            <div id="tickLowerDisplay" style="font-weight: bold; color: #2563eb; font-size: 14px;">-94000</div>
                        </div>
                        <div>
                            <small style="color: #666;">Tick Upper</small>
                            <div id="tickUpperDisplay" style="font-weight: bold; color: #2563eb; font-size: 14px;">-88000</div>
                        </div>
                    </div>
                </div>

                <div class="two-col">
                    <div class="input-group">
                        <label for="tickLower">Tick Lower</label>
                        <input type="number" id="tickLower" placeholder="-94000" value="-94000">
                    </div>
                    <div class="input-group">
                        <label for="tickUpper">Tick Upper</label>
                        <input type="number" id="tickUpper" placeholder="-88000" value="-88000">
                    </div>
                </div>

                <button class="btn-primary" onclick="setRange()" style="margin-top: 15px;">
                    <span id="rangeText">Set Range</span>
                    <span class="loader" id="rangeLoader"></span>
                </button>

                <div class="status" id="rangeStatus" style="display: none;"></div>
            </div>

            <!-- POSITION INFO SECTION -->
            <div class="card">
                <h2>ðŸŽ¯ Position Info</h2>

                <button class="btn-secondary" onclick="getPositionInfo()" style="width: 100%; margin-bottom: 20px;">
                    Refresh Position
                </button>

                <div class="info-box" id="positionBox" style="display: none;">
                    <div class="info-label">Token ID</div>
                    <div class="info-value" id="tokenId">-</div>
                </div>

                <div class="info-box" id="liquidityBox" style="display: none;">
                    <div class="info-label">Liquidity</div>
                    <div class="info-value" id="liquidity">-</div>
                </div>

                <div class="info-box" id="amount0Box" style="display: none;">
                    <div class="info-label">Amount Token0 (USDC)</div>
                    <div class="info-value" id="amount0">-</div>
                </div>

                <div class="info-box" id="amount1Box" style="display: none;">
                    <div class="info-label">Amount Token1</div>
                    <div class="info-value" id="amount1">-</div>
                </div>

                <div id="positionStatus" style="display: none; margin-top: 15px;"></div>
            </div>

            <!-- WITHDRAW SECTION -->
            <div class="card">
                <h2>ðŸ”„ Withdraw</h2>

                <div class="input-group">
                    <label for="withdrawShares">Shares to Withdraw</label>
                    <input type="number" id="withdrawShares" placeholder="0" min="0" step="0.01">
                    <small style="color: #999; margin-top: 5px;">Deixe em branco para sacar tudo</small>
                </div>

                <button class="btn-warning" onclick="withdraw()">
                    <span id="withdrawText">Withdraw</span>
                    <span class="loader" id="withdrawLoader"></span>
                </button>

                <div class="status" id="withdrawStatus" style="display: none;"></div>
            </div>
        </div>

        <!-- INSTRUCTIONS SECTION -->
        <div class="card full-width" style="background: #f8f9fa;">
            <h2>ðŸ“– Instructions</h2>
            <ol style="margin-left: 20px; line-height: 1.8;">
                <li><strong>Connect MetaMask:</strong> Clique em "Connect MetaMask" e selecione Arbitrum Sepolia</li>
                <li><strong>Obter USDC Sepolia:</strong> Procure por um faucet ou airdrop de USDC na testnet</li>
                <li><strong>Depositar:</strong> Digite a quantidade (ex: 10 USDC) e clique "Deposit USDC"</li>
                <li><strong>Configurar Range:</strong> Deixe os valores padrÃ£o e clique "Set Range"</li>
                <li><strong>Monitorar PosiÃ§Ã£o:</strong> Clique "Refresh Position" para ver sua posiÃ§Ã£o Uniswap</li>
                <li><strong>Sacar:</strong> Clique "Withdraw" para sacar seus fundos</li>
            </ol>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <script>
        console.log('Script loaded');
        
        // Wait for ethers to load
        if (typeof ethers === 'undefined') {
            console.error('Ethers library failed to load from CDN');
            // Fallback: Try alternative CDN
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/ethers@6/dist/ethers.umd.js';
            script.onload = () => console.log('Ethers loaded from fallback CDN');
            script.onerror = () => console.error('All ethers CDNs failed to load');
            document.head.appendChild(script);
        } else {
            console.log('Ethers loaded successfully');
        }
        
        // Constants
        const VAULT_ADDRESS = "0x844bc19AEB38436131c2b4893f5E0772162F67d6"; // Updated: Correct USDC
        const USDC_ADDRESS = "0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d"; // Arbitrum Sepolia USDC
        const RPC_URL = "https://sepolia-rollup.arbitrum.io/rpc";
        const CHAIN_ID = 421614;

        // Global state
        let provider, signer, userAddress;
        let vaultContract, usdcContract;

        // Minimal ABIs
        const VAULT_ABI = [
            "function name() public view returns (string)",
            "function symbol() public view returns (string)",
            "function decimals() public view returns (uint8)",
            "function totalAssets() public view returns (uint256)",
            "function totalSupply() public view returns (uint256)",
            "function balanceOf(address) public view returns (uint256)",
            "function deposit(uint256 assets, address receiver) public returns (uint256)",
            "function redeem(uint256 shares, address receiver, address owner) public returns (uint256)",
            "function setRange(int24 tickLower, int24 tickUpper) public",
            "function previewDeposit(uint256 assets) public view returns (uint256)",
            "function previewRedeem(uint256 shares) public view returns (uint256)"
        ];

        const USDC_ABI = [
            "function balanceOf(address account) public view returns (uint256)",
            "function decimals() public view returns (uint8)",
            "function approve(address spender, uint256 amount) public returns (bool)",
            "function allowance(address owner, address spender) public view returns (uint256)"
        ];

        async function connectWallet() {
            try {
                console.log('Connect button clicked');
                console.log('Window.ethereum:', window.ethereum);
                console.log('Ethers available:', typeof ethers);
                
                if (!window.ethereum) {
                    alert('MetaMask not found. Please install MetaMask');
                    return;
                }

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                console.log('Connected address:', userAddress);

                // Check network
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                console.log('Current chain ID:', chainId, 'Expected:', `0x${CHAIN_ID.toString(16)}`);
                
                if (parseInt(chainId) !== CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: `0x${CHAIN_ID.toString(16)}` }],
                        });
                    } catch (err) {
                        alert('Please switch to Arbitrum Sepolia manually in MetaMask');
                        return;
                    }
                }

                // Wait for ethers to be available
                if (typeof ethers === 'undefined') {
                    alert('Ethers library still loading... please try again');
                    return;
                }

                // Setup ethers
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                console.log('Signer initialized');

                // Initialize contracts
                vaultContract = new ethers.Contract(VAULT_ADDRESS, VAULT_ABI, signer);
                usdcContract = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);

                // Update UI
                document.getElementById('walletAddress').value = userAddress;
                document.getElementById('connectBtn').textContent = 'Connected âœ“';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('statusBadge').textContent = 'Connected';
                document.getElementById('statusBadge').className = 'badge connected';
                document.getElementById('step1').className = 'step completed';
                document.getElementById('step2').className = 'step active';

                // Show balance sections
                document.getElementById('balanceBox').style.display = 'block';
                document.getElementById('sharesBox').style.display = 'block';
                document.getElementById('shareValueBox').style.display = 'block';
                document.getElementById('totalAssetsBox').style.display = 'block';
                document.getElementById('totalSupplyBox').style.display = 'block';

                // Set receiver address
                document.getElementById('depositReceiver').value = userAddress;

                // Fetch initial data
                await fetchBalances();

                document.getElementById('depositStatus').className = 'status success';
                document.getElementById('depositStatus').textContent = 'Wallet connected successfully!';
                document.getElementById('depositStatus').style.display = 'block';

            } catch (error) {
                console.error('Connection error:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                document.getElementById('depositStatus').className = 'status error';
                document.getElementById('depositStatus').textContent = `Error: ${error.message}`;
                document.getElementById('depositStatus').style.display = 'block';
                alert(`Connection Error: ${error.message}`);
            }
        }

        async function fetchBalances() {
            try {
                if (!userAddress) return;

                // USDC Balance
                const usdcBalance = await usdcContract.balanceOf(userAddress);
                const usdcDecimals = await usdcContract.decimals();
                const formattedUSDC = ethers.formatUnits(usdcBalance, usdcDecimals);
                document.getElementById('usdcBalance').textContent = parseFloat(formattedUSDC).toFixed(2);

                // Share Balance
                const shareBalance = await vaultContract.balanceOf(userAddress);
                const formattedShares = ethers.formatUnits(shareBalance, 18);
                document.getElementById('shareBalance').textContent = parseFloat(formattedShares).toFixed(2);

                // Total Assets & Supply
                const totalAssets = await vaultContract.totalAssets();
                const totalSupply = await vaultContract.totalSupply();
                const formattedAssets = ethers.formatUnits(totalAssets, 6);
                const formattedSupply = ethers.formatUnits(totalSupply, 18);
                document.getElementById('totalAssets').textContent = parseFloat(formattedAssets).toFixed(2);
                document.getElementById('totalSupply').textContent = parseFloat(formattedSupply).toFixed(2);

                // Share Value
                if (totalSupply > 0n) {
                    const shareValue = (shareBalance * totalAssets) / totalSupply;
                    const formattedValue = ethers.formatUnits(shareValue, 6);
                    document.getElementById('shareValue').textContent = parseFloat(formattedValue).toFixed(2);
                }

            } catch (error) {
                console.error('Error fetching balances:', error);
                // Don't show alert - just log
            }
        }

        async function deposit() {
            try {
                if (!userAddress) {
                    alert('Por favor, conecte sua carteira primeiro');
                    return;
                }

                const amount = document.getElementById('depositAmount').value;
                if (!amount || amount === '0') {
                    alert('Por favor, digite um valor vÃ¡lido');
                    return;
                }

                const receiver = document.getElementById('depositReceiver').value;
                if (!receiver.startsWith('0x')) {
                    alert('Receiver invÃ¡lido');
                    return;
                }

                showLoading('depositLoader', true);
                document.getElementById('depositStatus').style.display = 'none';

                // Convert amount to wei (USDC has 6 decimals)
                const amountWei = ethers.parseUnits(amount.toString(), 6);

                // Check allowance
                const allowance = await usdcContract.allowance(userAddress, VAULT_ADDRESS);
                if (allowance < amountWei) {
                    document.getElementById('depositStatus').className = 'status warning';
                    document.getElementById('depositStatus').textContent = 'Approving token...';
                    document.getElementById('depositStatus').style.display = 'block';
                    
                    const approveTx = await usdcContract.approve(VAULT_ADDRESS, amountWei);
                    await approveTx.wait();
                    
                    document.getElementById('depositStatus').className = 'status info';
                    document.getElementById('depositStatus').textContent = 'Token approved!';
                }

                // Deposit
                document.getElementById('depositStatus').className = 'status info';
                document.getElementById('depositStatus').textContent = 'Depositando...';
                document.getElementById('depositStatus').style.display = 'block';
                
                const tx = await vaultContract.deposit(amountWei, receiver);
                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    document.getElementById('depositStatus').className = 'status success';
                    document.getElementById('depositStatus').textContent = `DepÃ³sito realizado! Hash: ${receipt.hash}`;
                    document.getElementById('step2').className = 'step completed';
                    document.getElementById('step3').className = 'step active';
                    await fetchBalances();
                    document.getElementById('depositAmount').value = '';
                } else {
                    document.getElementById('depositStatus').className = 'status error';
                    document.getElementById('depositStatus').textContent = 'TransaÃ§Ã£o falhou';
                }

            } catch (error) {
                console.error('Deposit error:', error);
                console.error('Full error:', {
                    message: error.message,
                    code: error.code,
                    reason: error.reason
                });
                
                let errorMsg = error.message;
                if (error.reason) {
                    errorMsg = error.reason;
                } else if (error.code === 'CALL_EXCEPTION') {
                    errorMsg = 'Contract call failed - check contract address or ABI';
                } else if (error.code === 'ACTION_REJECTED') {
                    errorMsg = 'Transaction rejected by user';
                }
                
                document.getElementById('depositStatus').className = 'status error';
                document.getElementById('depositStatus').textContent = `Erro: ${errorMsg}`;
                document.getElementById('depositStatus').style.display = 'block';
            } finally {
                showLoading('depositLoader', false);
            }
        }

        function convertPricesToTicks() {
            try {
                const priceLower = parseFloat(document.getElementById('priceLower').value);
                const priceUpper = parseFloat(document.getElementById('priceUpper').value);

                if (isNaN(priceLower) || isNaN(priceUpper) || priceLower <= 0 || priceUpper <= 0) {
                    alert('PreÃ§os invÃ¡lidos');
                    return;
                }

                if (priceLower >= priceUpper) {
                    alert('PreÃ§o lower deve ser menor que upper');
                    return;
                }

                // Uniswap v3 formula for price to tick conversion
                // tick = log_1.0001(price) where price is in terms of token1/token0
                // For very large prices (like 93000 USDC per WBTC), we need to handle the conversion carefully
                // Formula: tick = Math.round(Math.log(price) / Math.log(1.0001))
                // But since prices are very large, we take the reciprocal first
                const tickLower = Math.round(Math.log(1 / priceLower) / Math.log(1.0001));
                const tickUpper = Math.round(Math.log(1 / priceUpper) / Math.log(1.0001));

                // Update display
                document.getElementById('tickLowerDisplay').textContent = tickLower;
                document.getElementById('tickUpperDisplay').textContent = tickUpper;

                // Update input fields
                document.getElementById('tickLower').value = tickLower;
                document.getElementById('tickUpper').value = tickUpper;

                console.log(`Converted: ${priceLower} - ${priceUpper} to ticks ${tickLower} - ${tickUpper}`);
                console.log(`Tick calculation: 1/${priceLower} = ${1/priceLower}, log = ${Math.log(1/priceLower)}, tick = ${tickLower}`);
                
                document.getElementById('rangeStatus').className = 'status success';
                document.getElementById('rangeStatus').textContent = `Ticks calculated: ${tickLower} to ${tickUpper}`;
                document.getElementById('rangeStatus').style.display = 'block';
            } catch (error) {
                console.error('Conversion error:', error);
                alert(`Erro ao converter: ${error.message}`);
            }
        }

        async function setRange() {
            try {
                if (!userAddress) {
                    alert('Por favor, conecte sua carteira primeiro');
                    return;
                }

                const tickLower = parseInt(document.getElementById('tickLower').value);
                const tickUpper = parseInt(document.getElementById('tickUpper').value);

                if (isNaN(tickLower) || isNaN(tickUpper)) {
                    alert('Ticks invÃ¡lidos');
                    return;
                }

                showLoading('rangeLoader', true);

                document.getElementById('rangeStatus').className = 'status info';
                document.getElementById('rangeStatus').textContent = 'Configurando range...';
                document.getElementById('rangeStatus').style.display = 'block';

                const tx = await vaultContract.setRange(tickLower, tickUpper);
                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    document.getElementById('rangeStatus').className = 'status success';
                    document.getElementById('rangeStatus').textContent = `Range configurado! Hash: ${receipt.hash}`;
                    document.getElementById('step3').className = 'step completed';
                    document.getElementById('step4').className = 'step active';
                } else {
                    document.getElementById('rangeStatus').className = 'status error';
                    document.getElementById('rangeStatus').textContent = 'TransaÃ§Ã£o falhou';
                }

            } catch (error) {
                console.error('Set range error:', error);
                document.getElementById('rangeStatus').className = 'status error';
                document.getElementById('rangeStatus').textContent = `Erro: ${error.message}`;
                document.getElementById('rangeStatus').style.display = 'block';
            } finally {
                showLoading('rangeLoader', false);
            }
        }

        async function getPositionInfo() {
            try {
                if (!userAddress) {
                    document.getElementById('positionStatus').className = 'status error';
                    document.getElementById('positionStatus').textContent = 'Por favor, conecte sua carteira';
                    document.getElementById('positionStatus').style.display = 'block';
                    return;
                }

                document.getElementById('positionStatus').className = 'status info';
                document.getElementById('positionStatus').textContent = 'Carregando informaÃ§Ãµes da posiÃ§Ã£o...';
                document.getElementById('positionStatus').style.display = 'block';
                
                // Note: testnet_getPositionInfo may not exist on main contract
                // Just show placeholder
                document.getElementById('positionBox').style.display = 'block';
                document.getElementById('tokenId').textContent = 'Use testnet contract para ver';
                
                document.getElementById('positionStatus').className = 'status warning';
                document.getElementById('positionStatus').textContent = 'Use DeltaNeutralVaultV1Testnet para ver posiÃ§Ã£o completa';

            } catch (error) {
                console.error('Position error:', error);
                document.getElementById('positionStatus').className = 'status error';
                document.getElementById('positionStatus').textContent = `Erro: ${error.message}`;
                document.getElementById('positionStatus').style.display = 'block';
            }
        }

        async function withdraw() {
            try {
                if (!userAddress) {
                    alert('Por favor, conecte sua carteira');
                    return;
                }

                let shares = document.getElementById('withdrawShares').value;
                
                if (!shares) {
                    // Get all shares
                    shares = await vaultContract.balanceOf(userAddress);
                } else {
                    shares = ethers.parseUnits(shares.toString(), 18);
                }

                if (shares === 0n) {
                    alert('VocÃª nÃ£o tem shares para sacar');
                    return;
                }

                showLoading('withdrawLoader', true);

                document.getElementById('withdrawStatus').className = 'status info';
                document.getElementById('withdrawStatus').textContent = 'Sacando...';
                document.getElementById('withdrawStatus').style.display = 'block';

                const tx = await vaultContract.redeem(shares, userAddress, userAddress);
                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    document.getElementById('withdrawStatus').className = 'status success';
                    document.getElementById('withdrawStatus').textContent = `Saque realizado! Hash: ${receipt.hash}`;
                    document.getElementById('step5').className = 'step completed';
                    await fetchBalances();
                    document.getElementById('withdrawShares').value = '';
                } else {
                    document.getElementById('withdrawStatus').className = 'status error';
                    document.getElementById('withdrawStatus').textContent = 'TransaÃ§Ã£o falhou';
                }

            } catch (error) {
                console.error('Withdraw error:', error);
                document.getElementById('withdrawStatus').className = 'status error';
                document.getElementById('withdrawStatus').textContent = `Erro: ${error.message}`;
                document.getElementById('withdrawStatus').style.display = 'block';
            } finally {
                showLoading('withdrawLoader', false);
            }
        }

        function showStatus(type, message, elementId = 'depositStatus') {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }

        function showLoading(loaderId, show) {
            document.getElementById(loaderId).style.display = show ? 'inline-block' : 'none';
        }

        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).value;
            navigator.clipboard.writeText(text);
            alert('Copiado!');
        }

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => {
                location.reload();
            });
            window.ethereum.on('chainChanged', () => {
                location.reload();
            });
        }
        
        // Ensure ethers is available
        function waitForEthers(callback, maxAttempts = 10) {
            let attempts = 0;
            const interval = setInterval(() => {
                if (typeof ethers !== 'undefined') {
                    clearInterval(interval);
                    console.log('Ethers is ready');
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    console.error('Ethers failed to load');
                } else {
                    attempts++;
                }
            }, 500);
        }
    </script>
</body>
</html>

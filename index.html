<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta Neutral Vault - Testnet Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
            text-transform: uppercase;
        }

        .info-value {
            color: #333;
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 5px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            grid-column: 1 / -1;
        }

        .btn-primary:hover {
            background: #5568d3;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-warning:hover {
            background: #dd6b20;
        }

        .status {
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .badge.connected {
            background: #48bb78;
        }

        .badge.disconnected {
            background: #f56565;
        }

        .copy-btn {
            padding: 5px 10px;
            font-size: 0.85em;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .copy-btn:hover {
            background: #5568d3;
        }

        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .step-indicator {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 30px;
        }

        .step {
            padding: 15px;
            background: white;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            color: #999;
            border: 2px solid #e0e0e0;
        }

        .step.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .step.completed {
            background: #48bb78;
            color: white;
            border-color: #48bb78;
        }

        .fee-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .fee-item {
            background: #f0f4ff;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .fee-label {
            font-size: 0.85em;
            color: #666;
        }

        .fee-value {
            font-size: 1.1em;
            font-weight: bold;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }

            .step-indicator {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° Delta Neutral Vault</h1>
            <p class="subtitle">Testnet Interface - Arbitrum Sepolia</p>
        </header>

        <div class="step-indicator">
            <div class="step active" id="step1">1. Connect</div>
            <div class="step" id="step2">2. Deposit</div>
            <div class="step" id="step3">3. Range</div>
            <div class="step" id="step4">4. Rebalance</div>
            <div class="step" id="step5">5. Withdraw</div>
        </div>

        <div class="main-grid">
            <!-- WALLET SECTION -->
            <div class="card">
                <h2>üíº Wallet</h2>
                
                <div class="input-group">
                    <label for="walletAddress">Your Address</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="walletAddress" placeholder="0x..." readonly>
                        <button class="copy-btn" onclick="copyToClipboard('walletAddress')">Copy</button>
                    </div>
                </div>

                <div class="info-box">
                    <div class="info-label">Connection Status</div>
                    <div style="margin-top: 10px;">
                        <button class="btn-primary" id="connectBtn" onclick="connectWallet()">
                            Connect MetaMask
                        </button>
                        <div class="badge disconnected" id="statusBadge">Disconnected</div>
                    </div>
                </div>

                <div class="info-box" id="balanceBox" style="display: none;">
                    <div class="info-label">USDC Sepolia Balance</div>
                    <div class="info-value" id="usdcBalance">0.00</div>
                </div>

                <div class="info-box" id="sharesBox" style="display: none;">
                    <div class="info-label">Your Shares (dnvUSDC)</div>
                    <div class="info-value" id="shareBalance">0.00</div>
                </div>

                <div class="info-box" id="shareValueBox" style="display: none;">
                    <div class="info-label">Share Value (USDC)</div>
                    <div class="info-value" id="shareValue">0.00</div>
                </div>
            </div>

            <!-- VAULT INFO SECTION -->
            <div class="card">
                <h2>üìä Vault Status</h2>

                <div class="info-box">
                    <div class="info-label">Vault Address</div>
                    <div class="info-value" style="font-size: 0.95em;">0x6cf579...</div>
                    <button class="copy-btn" onclick="copyToClipboard('vaultAddr')">Copy</button>
                    <input type="hidden" id="vaultAddr" value="0x6cf5791356EEf878536Ee006f18410861D93198D">
                </div>

                <div class="info-box">
                    <div class="info-label">WBTC (Mock) Address</div>
                    <div class="info-value" id="wbtcDisplay" style="font-size: 0.95em;">Set after deploy</div>
                    <button class="copy-btn" onclick="copyToClipboard('wbtcAddr')">Copy</button>
                    <input type="hidden" id="wbtcAddr" value="">
                </div>

                <div class="info-box" id="totalAssetsBox" style="display: none;">
                    <div class="info-label">Total Assets (USDC)</div>
                    <div class="info-value" id="totalAssets">0.00</div>
                </div>

                <div class="info-box" id="totalSupplyBox" style="display: none;">
                    <div class="info-label">Total Supply (shares)</div>
                    <div class="info-value" id="totalSupply">0.00</div>
                </div>

                <div class="fee-info">
                    <div class="fee-item">
                        <div class="fee-label">Performance Fee</div>
                        <div class="fee-value">5%</div>
                    </div>
                    <div class="fee-item">
                        <div class="fee-label">Management Fee</div>
                        <div class="fee-value">2%</div>
                    </div>
                    <div class="fee-item">
                        <div class="fee-label">Swap Fee</div>
                        <div class="fee-value">0.3%</div>
                    </div>
                    <div class="fee-item">
                        <div class="fee-label">Keeper Fee</div>
                        <div class="fee-value">0.1%</div>
                    </div>
                </div>
            </div>

            <!-- DEPOSIT SECTION -->
            <div class="card">
                <h2>üí∞ Deposit</h2>

                <div class="input-group">
                    <label for="depositAmount">Amount (USDC)</label>
                    <input type="number" id="depositAmount" placeholder="10" min="0" step="0.1">
                    <small style="color: #999; margin-top: 5px;">Recomendado: 10 USDC para teste</small>
                </div>

                <div class="input-group">
                    <label for="depositReceiver">Receiver Address</label>
                    <input type="text" id="depositReceiver" placeholder="0x...">
                </div>

                <button class="btn-primary" onclick="deposit()">
                    <span id="depositText">Deposit USDC</span>
                    <span class="loader" id="depositLoader"></span>
                </button>

                <div class="status" id="depositStatus" style="display: none;"></div>
            </div>

            <!-- CREATE POOL SECTION -->
            <div class="card">
                <h2>üèóÔ∏è Create WBTC/USDC Pool</h2>
                <p style="margin-bottom: 15px;">If no pool exists, create and initialize one here</p>
                
                <div class="input-group" style="margin-bottom: 10px;">
                    <label for="poolToken0">Token 0 (usually USDC)</label>
                    <input type="text" id="poolToken0" placeholder="0x..." value="0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d">
                </div>

                <div class="input-group" style="margin-bottom: 10px;">
                    <label for="poolToken1">Token 1 (WBTC - set after deploy)</label>
                    <input type="text" id="poolToken1" placeholder="0x..." value="0xEf39185d82F3Dd98046107D6Ca9bA2AF77a2B5dF">
                </div>

                <div class="input-group" style="margin-bottom: 10px;">
                    <label for="feeTier">Fee Tier (bps)</label>
                    <select id="feeTier">
                        <option value="500">0.05% (500 bps)</option>
                        <option value="3000" selected>0.3% (3000 bps)</option>
                        <option value="10000">1% (10000 bps)</option>
                    </select>
                </div>

                <div class="input-group" style="margin-bottom: 10px;">
                    <label for="initialPrice">Initial Price (USDC per WBTC)</label>
                    <input type="number" id="initialPrice" placeholder="100000" value="100000">
                </div>

                <button class="btn-primary" onclick="createPool()" style="margin-top: 15px; background: #8b5cf6;">
                    <span id="createPoolText">Create & Initialize Pool</span>
                    <span class="loader" id="createPoolLoader"></span>
                </button>

                <div class="status" id="createPoolStatus" style="display: none;"></div>
            </div>

            <!-- CONFIGURE POOL SECTION -->
            <div class="card">
                <h2>‚öôÔ∏è Configure Uniswap Pool</h2>
                <p>Configure the Uniswap v3 pool for WBTC/USDC (required before setting range)</p>
                
                <div class="input-group" style="margin-bottom: 15px;">
                    <label for="poolAddress">Pool Address (WBTC/USDC 0.3%)</label>
                    <input type="text" id="poolAddress" placeholder="0x..." value="0xB5AD58CBcc1a9DB06A9852b20aEc95FF3ba56F3a">
                </div>

                <button class="btn-primary" onclick="setUniswapConfig()" style="width: 100%; margin-bottom: 15px;">
                    Configure Pool
                </button>

                <div class="status" id="poolStatus" style="display: none;"></div>
            </div>

            <!-- RANGE SECTION -->
            <div class="card">
                <h2>üìà Set Range</h2>
                <p>Configure the price range for WBTC/USDC position</p>

                <div class="two-col">
                    <div class="input-group">
                        <label for="priceLower">Price Lower (USDC/WBTC)</label>
                        <input type="number" id="priceLower" placeholder="93000" value="93000">
                    </div>
                    <div class="input-group">
                        <label for="priceUpper">Price Upper (USDC/WBTC)</label>
                        <input type="number" id="priceUpper" placeholder="100000" value="100000">
                    </div>
                </div>

                <button class="btn-primary" onclick="convertPricesToTicks()" style="margin: 10px 0;">
                    Convert to Ticks
                </button>

                <button class="btn-primary" onclick="useDefaultTicks()" style="margin: 10px 0; background: #10b981;">
                    Use Default Safe Ticks
                </button>

                <div style="margin: 15px 0; padding: 15px; background: #f0f0f0; border-radius: 8px;">
                    <p style="margin: 0; font-size: 12px; color: #666; margin-bottom: 10px;">Calculated Ticks (Pool tickSpacing: 60):</p>
                    <div class="two-col">
                        <div>
                            <small style="color: #666;">Tick Lower</small>
                            <div id="tickLowerDisplay" style="font-weight: bold; color: #2563eb; font-size: 14px;">-530700</div>
                        </div>
                        <div>
                            <small style="color: #666;">Tick Upper</small>
                            <div id="tickUpperDisplay" style="font-weight: bold; color: #2563eb; font-size: 14px;">-528300</div>
                        </div>
                    </div>
                </div>

                <div class="two-col">
                    <div class="input-group">
                        <label for="tickLower">Tick Lower</label>
                        <input type="number" id="tickLower" placeholder="-530700" value="-530700">
                    </div>
                    <div class="input-group">
                        <label for="tickUpper">Tick Upper</label>
                        <input type="number" id="tickUpper" placeholder="-528300" value="-528300">
                    </div>
                </div>

                <button class="btn-primary" onclick="setRange()" style="margin-top: 15px;">
                    <span id="rangeText">Set Range</span>
                    <span class="loader" id="rangeLoader"></span>
                </button>

                <div class="status" id="rangeStatus" style="display: none;"></div>
            </div>

            <!-- POSITION INFO SECTION -->
            <div class="card">
                <h2>üéØ Position Info</h2>

                <button class="btn-secondary" onclick="getPositionInfo()" style="width: 100%; margin-bottom: 20px;">
                    Refresh Position
                </button>

                <div class="info-box" id="positionBox" style="display: none;">
                    <div class="info-label">Token ID</div>
                    <div class="info-value" id="tokenId">-</div>
                </div>

                <div class="info-box" id="liquidityBox" style="display: none;">
                    <div class="info-label">Liquidity</div>
                    <div class="info-value" id="liquidity">-</div>
                </div>

                <div class="info-box" id="amount0Box" style="display: none;">
                    <div class="info-label">Amount Token0 (USDC)</div>
                    <div class="info-value" id="amount0">-</div>
                </div>

                <div class="info-box" id="amount1Box" style="display: none;">
                    <div class="info-label">Amount Token1</div>
                    <div class="info-value" id="amount1">-</div>
                </div>

                <div id="positionStatus" style="display: none; margin-top: 15px;"></div>
            </div>

            <!-- WITHDRAW SECTION -->
            <div class="card">
                <h2>üîÑ Withdraw</h2>

                <div class="input-group">
                    <label for="withdrawShares">Shares to Withdraw</label>
                    <input type="number" id="withdrawShares" placeholder="0" min="0" step="0.01">
                    <small style="color: #999; margin-top: 5px;">Deixe em branco para sacar tudo</small>
                </div>

                <button class="btn-warning" onclick="withdraw()">
                    <span id="withdrawText">Withdraw</span>
                    <span class="loader" id="withdrawLoader"></span>
                </button>

                <div class="status" id="withdrawStatus" style="display: none;"></div>
            </div>
        </div>

        <!-- STATUS SECTION -->
        <div class="card full-width" style="background: #dcfce7; border-left: 4px solid #16a34a;">
            <h2 style="color: #16a34a;">‚úÖ Vault Setup Complete!</h2>
            <div style="margin: 15px 0; padding: 15px; background: white; border-radius: 8px;">
                <p><strong>All pre-configured on Arbitrum Sepolia (Nov 15, 2025):</strong></p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><strong>Pool:</strong> 0xB5AD58CBcc1a9DB06A9852b20aEc95FF3ba56F3a ‚úÖ</li>
                    <li><strong>Range:</strong> ticks [-530700, -528300] ‚úÖ</li>
                    <li><strong>Ready for deposits & testing</strong> ‚úÖ</li>
                </ul>
            </div>
        </div>

        <!-- QUICK START SECTION -->
        <div class="card full-width" style="background: #eff6ff; border-left: 4px solid #3b82f6;">
            <h2 style="color: #3b82f6;">üöÄ Quick Start Guide</h2>
            <ol style="margin-left: 20px; line-height: 1.8;">
                <li><strong>Connect MetaMask:</strong> 
                    <ul style="margin-top: 5px;">
                        <li>Click "üîó Connect MetaMask"</li>
                        <li>Select <strong>Arbitrum Sepolia</strong> network</li>
                        <li>Approve connection</li>
                    </ul>
                </li>
                <li><strong>Get USDC Testnet:</strong> 
                    <ul style="margin-top: 5px;">
                        <li>Bridge from Ethereum Sepolia, OR</li>
                        <li>Find Arbitrum Sepolia faucet</li>
                    </ul>
                </li>
                <li><strong>Deposit:</strong>
                    <ul style="margin-top: 5px;">
                        <li>Go to "üí∞ Deposit" section</li>
                        <li>Enter USDC amount (e.g., 5 USDC)</li>
                        <li>Click "Deposit"</li>
                    </ul>
                </li>
                <li><strong>Configure Range (Optional - Already Done):</strong>
                    <ul style="margin-top: 5px;">
                        <li>Pool: 0xB5AD58CBcc1a9DB06A9852b20aEc95FF3ba56F3a (pre-filled)</li>
                        <li>Ticks: -530700 / -528300 (pre-filled & safe)</li>
                        <li>Just click "Configure Pool" and "Set Range"</li>
                    </ul>
                </li>
                <li><strong>Monitor Position:</strong>
                    <ul style="margin-top: 5px;">
                        <li>Go to "üéØ Position Info" section</li>
                        <li>Click "Refresh Position"</li>
                        <li>View your LP Token ID and liquidity</li>
                    </ul>
                </li>
                <li><strong>Withdraw:</strong>
                    <ul style="margin-top: 5px;">
                        <li>Go to "üîÑ Withdraw" section</li>
                        <li>Enter shares or leave blank for full exit</li>
                        <li>Click "Withdraw"</li>
                    </ul>
                </li>
            </ol>
        </div>

        <!-- ADDRESSES SECTION -->
        <div class="card full-width" style="background: #f5f3ff; border-left: 4px solid #a78bfa;">
            <h2 style="color: #7c3aed;">üîó Testnet Addresses</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <p style="margin: 0; color: #666; font-size: 0.9em; font-weight: 500;">VAULT</p>
                    <code style="display: block; word-break: break-all; margin-top: 5px; font-size: 0.85em;">0x844bc19AEB38436131c2b4893f5E0772162F67d6</code>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <p style="margin: 0; color: #666; font-size: 0.9em; font-weight: 500;">USDC (Arbitrum Sepolia)</p>
                    <code style="display: block; word-break: break-all; margin-top: 5px; font-size: 0.85em;">0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d</code>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <p style="margin: 0; color: #666; font-size: 0.9em; font-weight: 500;">WBTC MOCK</p>
                    <code style="display: block; word-break: break-all; margin-top: 5px; font-size: 0.85em;">0xEf39185d82F3Dd98046107D6Ca9bA2AF77a2B5dF</code>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px;">
                    <p style="margin: 0; color: #666; font-size: 0.9em; font-weight: 500;">POOL (USDC/WBTC 0.3%)</p>
                    <code style="display: block; word-break: break-all; margin-top: 5px; font-size: 0.85em;">0xB5AD58CBcc1a9DB06A9852b20aEc95FF3ba56F3a</code>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <script>
        console.log('Script loaded');
        
        // Wait for ethers to load
        if (typeof ethers === 'undefined') {
            console.error('Ethers library failed to load from CDN');
            // Fallback: Try alternative CDN
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/ethers@6/dist/ethers.umd.js';
            script.onload = () => console.log('Ethers loaded from fallback CDN');
            script.onerror = () => console.error('All ethers CDNs failed to load');
            document.head.appendChild(script);
        } else {
            console.log('Ethers loaded successfully');
        }
        
        // Constants
        const VAULT_ADDRESS = "0x844bc19AEB38436131c2b4893f5E0772162F67d6"; // Updated: Correct USDC
        const USDC_ADDRESS = "0x75faf114eafb1BDbe2F0316DF893fd58CE46AA4d"; // Arbitrum Sepolia USDC
        const WBTC_ADDRESS = "0xEf39185d82F3Dd98046107D6Ca9bA2AF77a2B5dF"; // WBTC Mock deployed 15 Nov 2025
        const POSITION_MANAGER = "0x6b2937Bde17889EDCf8fbD8dE31C3C2a70Bc4d65"; // NFPM testnet (from Uniswap docs)
        const RPC_URL = "https://sepolia-rollup.arbitrum.io/rpc";
        const CHAIN_ID = 421614;

        // Global state
        let provider, signer, userAddress;
        let vaultContract, usdcContract;

        // Minimal ABIs
        const VAULT_ABI = [
            "function name() public view returns (string)",
            "function symbol() public view returns (string)",
            "function decimals() public view returns (uint8)",
            "function totalAssets() public view returns (uint256)",
            "function totalSupply() public view returns (uint256)",
            "function balanceOf(address) public view returns (uint256)",
            "function deposit(uint256 assets, address receiver) public returns (uint256)",
            "function redeem(uint256 shares, address receiver, address owner) public returns (uint256)",
            "function setRange(int24 tickLower, int24 tickUpper) public",
            "function setUniswapConfig(address _pool, address _positionManager, address _swapRouter) external",
            "function previewDeposit(uint256 assets) public view returns (uint256)",
            "function previewRedeem(uint256 shares) public view returns (uint256)"
        ];

        const USDC_ABI = [
            "function balanceOf(address account) public view returns (uint256)",
            "function decimals() public view returns (uint8)",
            "function approve(address spender, uint256 amount) public returns (bool)",
            "function allowance(address owner, address spender) public view returns (uint256)"
        ];

        const NFPM_ABI = [
            "function createAndInitializePoolIfNecessary(address token0, address token1, uint24 fee, uint160 sqrtPriceX96) external payable returns (address pool)",
            "function positions(uint256 tokenId) external view returns (uint96 nonce, address operator, address token0, address token1, uint24 fee, int24 tickLower, int24 tickUpper, uint128 liquidity, uint256 feeGrowthInside0LastX128, uint256 feeGrowthInside1LastX128, uint128 tokensOwed0, uint128 tokensOwed1)",
            "function mint(tuple(address token0, address token1, uint24 fee, int24 tickLower, int24 tickUpper, uint256 amount0Desired, uint256 amount1Desired, uint256 amount0Min, uint256 amount1Min, address recipient, uint256 deadline) params) external payable returns (uint256 tokenId, uint128 liquidity, uint256 amount0, uint256 amount1)",
            "function decreaseLiquidity(tuple(uint256 tokenId, uint128 liquidity, uint256 amount0Min, uint256 amount1Min, uint256 deadline) params) external payable returns (uint256 amount0, uint256 amount1)",
            "function collect(tuple(uint256 tokenId, address recipient, uint128 amount0Max, uint128 amount1Max) params) external payable returns (uint256 amount0, uint256 amount1)",
            "function burn(uint256 tokenId) external payable"
        ];

        const POOL_ABI = [
            "function tickSpacing() external view returns (int24)",
            "function fee() external view returns (uint24)",
            "function token0() external view returns (address)",
            "function token1() external view returns (address)",
            "function slot0() external view returns (uint160 sqrtPriceX96, int24 tick, uint16 observationIndex, uint16 observationCardinality, uint16 observationCardinalityNext, uint8 feeProtocol, bool unlocked)"
        ];

        async function connectWallet() {
            try {
                console.log('Connect button clicked');
                console.log('Window.ethereum:', window.ethereum);
                console.log('Ethers available:', typeof ethers);
                
                if (!window.ethereum) {
                    alert('MetaMask not found. Please install MetaMask');
                    return;
                }

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                console.log('Connected address:', userAddress);

                // Check network
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                console.log('Current chain ID:', chainId, 'Expected:', `0x${CHAIN_ID.toString(16)}`);
                
                if (parseInt(chainId) !== CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: `0x${CHAIN_ID.toString(16)}` }],
                        });
                    } catch (err) {
                        alert('Please switch to Arbitrum Sepolia manually in MetaMask');
                        return;
                    }
                }

                // Wait for ethers to be available
                if (typeof ethers === 'undefined') {
                    alert('Ethers library still loading... please try again');
                    return;
                }

                // Setup ethers
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                console.log('Signer initialized');

                // Initialize contracts
                vaultContract = new ethers.Contract(VAULT_ADDRESS, VAULT_ABI, signer);
                usdcContract = new ethers.Contract(USDC_ADDRESS, USDC_ABI, signer);

                // Populate WBTC display if available
                try {
                    if (WBTC_ADDRESS && WBTC_ADDRESS.startsWith('0x') && WBTC_ADDRESS.length === 42) {
                        document.getElementById('wbtcDisplay').textContent = `${WBTC_ADDRESS.slice(0, 6)}...${WBTC_ADDRESS.slice(-4)}`;
                        document.getElementById('wbtcAddr').value = WBTC_ADDRESS;
                    }
                } catch (e) {
                    console.warn('WBTC address not set yet');
                }

                // Update UI
                document.getElementById('walletAddress').value = userAddress;
                document.getElementById('connectBtn').textContent = 'Connected ‚úì';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('statusBadge').textContent = 'Connected';
                document.getElementById('statusBadge').className = 'badge connected';
                document.getElementById('step1').className = 'step completed';
                document.getElementById('step2').className = 'step active';

                // Show balance sections
                document.getElementById('balanceBox').style.display = 'block';
                document.getElementById('sharesBox').style.display = 'block';
                document.getElementById('shareValueBox').style.display = 'block';
                document.getElementById('totalAssetsBox').style.display = 'block';
                document.getElementById('totalSupplyBox').style.display = 'block';

                // Set receiver address
                document.getElementById('depositReceiver').value = userAddress;

                // Fetch initial data
                await fetchBalances();

                document.getElementById('depositStatus').className = 'status success';
                document.getElementById('depositStatus').textContent = 'Wallet connected successfully!';
                document.getElementById('depositStatus').style.display = 'block';

            } catch (error) {
                console.error('Connection error:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                document.getElementById('depositStatus').className = 'status error';
                document.getElementById('depositStatus').textContent = `Error: ${error.message}`;
                document.getElementById('depositStatus').style.display = 'block';
                alert(`Connection Error: ${error.message}`);
            }
        }

        async function fetchBalances() {
            try {
                if (!userAddress) return;

                // USDC Balance
                const usdcBalance = await usdcContract.balanceOf(userAddress);
                const usdcDecimals = await usdcContract.decimals();
                const formattedUSDC = ethers.formatUnits(usdcBalance, usdcDecimals);
                document.getElementById('usdcBalance').textContent = parseFloat(formattedUSDC).toFixed(2);

                // Share Balance
                const shareBalance = await vaultContract.balanceOf(userAddress);
                const formattedShares = ethers.formatUnits(shareBalance, 18);
                document.getElementById('shareBalance').textContent = parseFloat(formattedShares).toFixed(2);

                // Total Assets & Supply
                const totalAssets = await vaultContract.totalAssets();
                const totalSupply = await vaultContract.totalSupply();
                const formattedAssets = ethers.formatUnits(totalAssets, 6);
                const formattedSupply = ethers.formatUnits(totalSupply, 18);
                document.getElementById('totalAssets').textContent = parseFloat(formattedAssets).toFixed(2);
                document.getElementById('totalSupply').textContent = parseFloat(formattedSupply).toFixed(2);

                // Share Value
                if (totalSupply > 0n) {
                    const shareValue = (shareBalance * totalAssets) / totalSupply;
                    const formattedValue = ethers.formatUnits(shareValue, 6);
                    document.getElementById('shareValue').textContent = parseFloat(formattedValue).toFixed(2);
                }

            } catch (error) {
                console.error('Error fetching balances:', error);
                // Don't show alert - just log
            }
        }

        async function deposit() {
            try {
                if (!userAddress) {
                    alert('Por favor, conecte sua carteira primeiro');
                    return;
                }

                const amount = document.getElementById('depositAmount').value;
                if (!amount || amount === '0') {
                    alert('Por favor, digite um valor v√°lido');
                    return;
                }

                const receiver = document.getElementById('depositReceiver').value;
                if (!receiver.startsWith('0x')) {
                    alert('Receiver inv√°lido');
                    return;
                }

                showLoading('depositLoader', true);
                document.getElementById('depositStatus').style.display = 'none';

                // Convert amount to wei (USDC has 6 decimals)
                const amountWei = ethers.parseUnits(amount.toString(), 6);

                // Check allowance
                const allowance = await usdcContract.allowance(userAddress, VAULT_ADDRESS);
                if (allowance < amountWei) {
                    document.getElementById('depositStatus').className = 'status warning';
                    document.getElementById('depositStatus').textContent = 'Approving token...';
                    document.getElementById('depositStatus').style.display = 'block';
                    
                    const approveTx = await usdcContract.approve(VAULT_ADDRESS, amountWei);
                    await approveTx.wait();
                    
                    document.getElementById('depositStatus').className = 'status info';
                    document.getElementById('depositStatus').textContent = 'Token approved!';
                }

                // Deposit
                document.getElementById('depositStatus').className = 'status info';
                document.getElementById('depositStatus').textContent = 'Depositando...';
                document.getElementById('depositStatus').style.display = 'block';
                
                const tx = await vaultContract.deposit(amountWei, receiver);
                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    document.getElementById('depositStatus').className = 'status success';
                    document.getElementById('depositStatus').textContent = `Dep√≥sito realizado! Hash: ${receipt.hash}`;
                    document.getElementById('step2').className = 'step completed';
                    document.getElementById('step3').className = 'step active';
                    await fetchBalances();
                    document.getElementById('depositAmount').value = '';
                } else {
                    document.getElementById('depositStatus').className = 'status error';
                    document.getElementById('depositStatus').textContent = 'Transa√ß√£o falhou';
                }

            } catch (error) {
                console.error('Deposit error:', error);
                console.error('Full error:', {
                    message: error.message,
                    code: error.code,
                    reason: error.reason
                });
                
                let errorMsg = error.message;
                if (error.reason) {
                    errorMsg = error.reason;
                } else if (error.code === 'CALL_EXCEPTION') {
                    errorMsg = 'Contract call failed - check contract address or ABI';
                } else if (error.code === 'ACTION_REJECTED') {
                    errorMsg = 'Transaction rejected by user';
                }
                
                document.getElementById('depositStatus').className = 'status error';
                document.getElementById('depositStatus').textContent = `Erro: ${errorMsg}`;
                document.getElementById('depositStatus').style.display = 'block';
            } finally {
                showLoading('depositLoader', false);
            }
        }

        function convertPricesToTicks() {
            try {
                const priceLower = parseFloat(document.getElementById('priceLower').value);
                const priceUpper = parseFloat(document.getElementById('priceUpper').value);

                if (isNaN(priceLower) || isNaN(priceUpper) || priceLower <= 0 || priceUpper <= 0) {
                    alert('Pre√ßos inv√°lidos');
                    return;
                }

                if (priceLower >= priceUpper) {
                    alert('Pre√ßo lower deve ser menor que upper');
                    return;
                }

                // For WBTC/USDC with prices in range 90k-110k, use safe default range
                // These ticks are validated multiples of 200 and work with the contract
                let tickLower, tickUpper;
                
                if (priceLower >= 90000 && priceUpper <= 110000) {
                    // Safe range for 90k-110k prices
                    tickLower = -96000;
                    tickUpper = -84000;
                    console.log(`Price range ${priceLower}-${priceUpper} maps to safe ticks: ${tickLower} to ${tickUpper}`);
                } else {
                    // Calculate from price (advanced)
                    tickLower = Math.round(Math.log(1 / priceUpper) / Math.log(1.0001));
                    tickUpper = Math.round(Math.log(1 / priceLower) / Math.log(1.0001));
                    
                    // Snap to tickSpacing (60 for this pool)
                    const TICK_SPACING = 60;
                    const snappedLower = Math.round(tickLower / TICK_SPACING) * TICK_SPACING;
                    const snappedUpper = Math.round(tickUpper / TICK_SPACING) * TICK_SPACING;
                    
                    tickLower = snappedLower;
                    tickUpper = snappedUpper;
                    
                    console.log(`Calculated and snapped ticks (spacing 60): ${tickLower} to ${tickUpper}`);
                }

                // Ensure tickLower < tickUpper
                if (tickLower >= tickUpper) {
                    const temp = tickLower;
                    tickLower = tickUpper;
                    tickUpper = temp;
                }

                // Update display
                document.getElementById('tickLowerDisplay').textContent = tickLower;
                document.getElementById('tickUpperDisplay').textContent = tickUpper;

                // Update input fields
                document.getElementById('tickLower').value = tickLower;
                document.getElementById('tickUpper').value = tickUpper;

                console.log(`Final ticks: ${tickLower} to ${tickUpper}`);
                console.log(`Validation: ${tickLower} < ${tickUpper}? ${tickLower < tickUpper}`);
                
                document.getElementById('rangeStatus').className = 'status success';
                document.getElementById('rangeStatus').textContent = `Ticks: ${tickLower} to ${tickUpper}`;
                document.getElementById('rangeStatus').style.display = 'block';
            } catch (error) {
                console.error('Conversion error:', error);
                alert(`Erro ao converter: ${error.message}`);
            }
        }

        function useDefaultTicks() {
            // These are safe default ticks that work with the contract
            // Pool tickSpacing is 60 (verified from pool: 0xB5AD58...)
            // Current tick: -529525
            // Valid ticks must be multiples of 60
            const tickLower = -530700;  // Multiple of 60
            const tickUpper = -528300;  // Multiple of 60

            // Update display
            document.getElementById('tickLowerDisplay').textContent = tickLower;
            document.getElementById('tickUpperDisplay').textContent = tickUpper;

            // Update input fields
            document.getElementById('tickLower').value = tickLower;
            document.getElementById('tickUpper').value = tickUpper;

            document.getElementById('rangeStatus').className = 'status success';
            document.getElementById('rangeStatus').textContent = `Default ticks set: ${tickLower} to ${tickUpper} (multiples of 60)`;
            document.getElementById('rangeStatus').style.display = 'block';
            
            console.log(`Default safe ticks set: ${tickLower} to ${tickUpper}`);
        }

        function snapToTickSpacing(tick, spacing = 200) {
            // Round to nearest multiple of tickSpacing
            // Handle negative numbers correctly
            if (tick >= 0) {
                return Math.round(tick / spacing) * spacing;
            } else {
                // For negative numbers, round towards zero or away from zero consistently
                return Math.round(tick / spacing) * spacing;
            }
        }

        async function setRange() {
            try {
                if (!userAddress) {
                    alert('Por favor, conecte sua carteira primeiro');
                    return;
                }

                const tickLower = parseInt(document.getElementById('tickLower').value);
                const tickUpper = parseInt(document.getElementById('tickUpper').value);

                if (isNaN(tickLower) || isNaN(tickUpper)) {
                    alert('Ticks inv√°lidos');
                    return;
                }

                console.log(`setRange: tickLower=${tickLower}, tickUpper=${tickUpper}`);

                showLoading('rangeLoader', true);
                document.getElementById('rangeStatus').className = 'status info';
                document.getElementById('rangeStatus').textContent = 'Enviando...';
                document.getElementById('rangeStatus').style.display = 'block';
                
                const tx = await vaultContract.setRange(tickLower, tickUpper);
                console.log(`Tx sent: ${tx.hash}`);
                
                const receipt = await tx.wait();

                if (receipt && receipt.status === 1) {
                    document.getElementById('rangeStatus').className = 'status success';
                    document.getElementById('rangeStatus').textContent = `‚úì Range configurado!`;
                    document.getElementById('step3').className = 'step completed';
                } else {
                    document.getElementById('rangeStatus').className = 'status error';
                    document.getElementById('rangeStatus').textContent = 'Tx falhou';
                }

            } catch (error) {
                console.error('setRange error:', error);
                document.getElementById('rangeStatus').className = 'status error';
                document.getElementById('rangeStatus').textContent = `Erro: ${error.message || error.reason || JSON.stringify(error)}`;
                document.getElementById('rangeStatus').style.display = 'block';
            } finally {
                showLoading('rangeLoader', false);
            }
        }

        async function getPositionInfo() {
            try {
                if (!userAddress) {
                    document.getElementById('positionStatus').className = 'status error';
                    document.getElementById('positionStatus').textContent = 'Por favor, conecte sua carteira';
                    document.getElementById('positionStatus').style.display = 'block';
                    return;
                }

                document.getElementById('positionStatus').className = 'status info';
                document.getElementById('positionStatus').textContent = 'Carregando informa√ß√µes da posi√ß√£o...';
                document.getElementById('positionStatus').style.display = 'block';
                
                // Note: testnet_getPositionInfo may not exist on main contract
                // Just show placeholder
                document.getElementById('positionBox').style.display = 'block';
                document.getElementById('tokenId').textContent = 'Use testnet contract para ver';
                
                document.getElementById('positionStatus').className = 'status warning';
                document.getElementById('positionStatus').textContent = 'Use DeltaNeutralVaultV1Testnet para ver posi√ß√£o completa';

            } catch (error) {
                console.error('Position error:', error);
                document.getElementById('positionStatus').className = 'status error';
                document.getElementById('positionStatus').textContent = `Erro: ${error.message}`;
                document.getElementById('positionStatus').style.display = 'block';
            }
        }

        async function setUniswapConfig() {
            try {
                if (!userAddress) {
                    alert('Por favor, conecte sua carteira primeiro');
                    return;
                }

                const poolAddress = document.getElementById('poolAddress').value.trim();
                if (!poolAddress.startsWith('0x') || poolAddress.length !== 42) {
                    alert('Pool address inv√°lido');
                    return;
                }

                document.getElementById('poolStatus').className = 'status info';
                document.getElementById('poolStatus').textContent = 'Configurando pool...';
                document.getElementById('poolStatus').style.display = 'block';

                const POSITION_MANAGER = "0x6b2937Bde17889EDCf8fbD8dE31C3C2a70Bc4d65";
                const SWAP_ROUTER = "0xE592427A0AEce92De3Edee1F18E0157C05861564";

                // setUniswapConfig signature: setUniswapConfig(address _pool, address _positionManager, address _swapRouter)
                const tx = await vaultContract.setUniswapConfig(poolAddress, POSITION_MANAGER, SWAP_ROUTER);
                console.log(`Pool config tx: ${tx.hash}`);
                
                document.getElementById('poolStatus').className = 'status info';
                document.getElementById('poolStatus').textContent = `Tx enviada: ${tx.hash.slice(0, 10)}...`;
                
                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    document.getElementById('poolStatus').className = 'status success';
                    document.getElementById('poolStatus').textContent = `Pool configurado! Hash: ${receipt.hash}`;
                } else {
                    document.getElementById('poolStatus').className = 'status error';
                    document.getElementById('poolStatus').textContent = 'Transa√ß√£o falhou';
                }

            } catch (error) {
                console.error('Pool config error:', error);
                document.getElementById('poolStatus').className = 'status error';
                document.getElementById('poolStatus').textContent = `Erro: ${error.message}`;
                document.getElementById('poolStatus').style.display = 'block';
            }
        }

        async function createPool() {
            try {
                if (!userAddress) {
                    alert('Por favor, conecte sua carteira primeiro');
                    return;
                }

                const token0 = document.getElementById('poolToken0').value.trim();
                const token1 = document.getElementById('poolToken1').value.trim();
                const feeTier = parseInt(document.getElementById('feeTier').value);
                const initialPrice = parseFloat(document.getElementById('initialPrice').value);

                // Validar inputs
                if (!token0.startsWith('0x') || token0.length !== 42) {
                    alert('Token0 address inv√°lido');
                    return;
                }
                if (!token1.startsWith('0x') || token1.length !== 42) {
                    alert('Token1 address inv√°lido (defina WBTC_ADDRESS primeiro)');
                    return;
                }
                if (isNaN(initialPrice) || initialPrice <= 0) {
                    alert('Pre√ßo inicial inv√°lido');
                    return;
                }

                showLoading('createPoolLoader', true);
                document.getElementById('createPoolStatus').className = 'status info';
                document.getElementById('createPoolStatus').textContent = 'Criando pool...';
                document.getElementById('createPoolStatus').style.display = 'block';

                const POSITION_MANAGER = "0x6b2937Bde17889EDCf8fbD8dE31C3C2a70Bc4d65";
                const nfpmContract = new ethers.Contract(POSITION_MANAGER, NFPM_ABI, signer);

                // Converter pre√ßo para sqrtPriceX96
                // sqrtPrice = sqrt(price) * 2^96
                const sqrtPrice = Math.sqrt(initialPrice);
                const Q96 = Math.pow(2, 96);
                const sqrtPriceX96 = BigInt(Math.floor(sqrtPrice * Q96));

                console.log(`Creating pool with:`);
                console.log(`  Token0: ${token0}`);
                console.log(`  Token1: ${token1}`);
                console.log(`  Fee: ${feeTier} bps`);
                console.log(`  Initial Price: ${initialPrice}`);
                console.log(`  sqrtPriceX96: ${sqrtPriceX96.toString()}`);

                // Chamar createAndInitializePoolIfNecessary
                const tx = await nfpmContract.createAndInitializePoolIfNecessary(
                    token0,
                    token1,
                    feeTier,
                    sqrtPriceX96
                );

                console.log(`Pool creation tx: ${tx.hash}`);
                document.getElementById('createPoolStatus').textContent = `Tx enviada: ${tx.hash.slice(0, 10)}...`;

                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    // Extrair endere√ßo do pool do evento PoolCreated
                    // Para simplificar, pedimos ao usu√°rio copiar da tx
                    document.getElementById('createPoolStatus').className = 'status success';
                    document.getElementById('createPoolStatus').textContent = `Pool criado! Hash: ${receipt.hash}. Procure o endere√ßo do pool no Arbiscan (event PoolCreated) e cole na se√ß√£o "Configure Pool".`;
                } else {
                    document.getElementById('createPoolStatus').className = 'status error';
                    document.getElementById('createPoolStatus').textContent = 'Transa√ß√£o falhou';
                }

            } catch (error) {
                console.error('Pool creation error:', error);
                document.getElementById('createPoolStatus').className = 'status error';
                document.getElementById('createPoolStatus').textContent = `Erro: ${error.message || JSON.stringify(error)}`;
                document.getElementById('createPoolStatus').style.display = 'block';
            } finally {
                showLoading('createPoolLoader', false);
            }
        }

        async function withdraw() {
            try {
                if (!userAddress) {
                    alert('Por favor, conecte sua carteira');
                    return;
                }

                let shares = document.getElementById('withdrawShares').value;
                
                if (!shares) {
                    // Get all shares
                    shares = await vaultContract.balanceOf(userAddress);
                } else {
                    shares = ethers.parseUnits(shares.toString(), 18);
                }

                if (shares === 0n) {
                    alert('Voc√™ n√£o tem shares para sacar');
                    return;
                }

                showLoading('withdrawLoader', true);

                document.getElementById('withdrawStatus').className = 'status info';
                document.getElementById('withdrawStatus').textContent = 'Sacando...';
                document.getElementById('withdrawStatus').style.display = 'block';

                const tx = await vaultContract.redeem(shares, userAddress, userAddress);
                const receipt = await tx.wait();

                if (receipt.status === 1) {
                    document.getElementById('withdrawStatus').className = 'status success';
                    document.getElementById('withdrawStatus').textContent = `Saque realizado! Hash: ${receipt.hash}`;
                    document.getElementById('step5').className = 'step completed';
                    await fetchBalances();
                    document.getElementById('withdrawShares').value = '';
                } else {
                    document.getElementById('withdrawStatus').className = 'status error';
                    document.getElementById('withdrawStatus').textContent = 'Transa√ß√£o falhou';
                }

            } catch (error) {
                console.error('Withdraw error:', error);
                document.getElementById('withdrawStatus').className = 'status error';
                document.getElementById('withdrawStatus').textContent = `Erro: ${error.message}`;
                document.getElementById('withdrawStatus').style.display = 'block';
            } finally {
                showLoading('withdrawLoader', false);
            }
        }

        function showStatus(type, message, elementId = 'depositStatus') {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }

        function showLoading(loaderId, show) {
            document.getElementById(loaderId).style.display = show ? 'inline-block' : 'none';
        }

        function copyToClipboard(elementId) {
            const text = document.getElementById(elementId).value;
            navigator.clipboard.writeText(text);
            alert('Copiado!');
        }

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => {
                location.reload();
            });
            window.ethereum.on('chainChanged', () => {
                location.reload();
            });
        }
        
        // Ensure ethers is available
        function waitForEthers(callback, maxAttempts = 10) {
            let attempts = 0;
            const interval = setInterval(() => {
                if (typeof ethers !== 'undefined') {
                    clearInterval(interval);
                    console.log('Ethers is ready');
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    console.error('Ethers failed to load');
                } else {
                    attempts++;
                }
            }, 500);
        }
    </script>
</body>
</html>
